#!/usr//bin/perl

use DateTime;
use SC6::Cam::General;
use SC6::Cam::BlueCodeState;
use SC6::Cam::Config;
use SC6::Cam::Image;
use SC6::Cam::Sun;
use SC6::Cam::GStore;
use Getopt::Long;
use Data::Dumper;

my $force = 0;
our $mode = "prod";
my $dryrun = 0;
my $current_bluecode;

my $c = new SC6::Cam::Config("/usr/local/cam/conf/config.yml");
our $config = $c->getConfig();
our $debug = $c->getDebug();
print "\n***** STARTING *****\n" if ( $debug );

# startup mail
startup_mail();

$result = GetOptions (  "n|dry-run" => \$dryrun,
                        "f|force"  => \$force,
                        "h|help"  => \&usage,
                        "m|mode=s"  => \$mode,
                        "d|debug+"  => \$debug);

# prime bluecode
my $bcr = new SC6::Cam::BlueCodeState();
print "primed bluecode is: ", $bcr->getBluecode(), "\n" if ( $debug );
our $gstore = new SC6::Cam::GStore();

my $sleep_time = $config->{'General'}->{'ImageInterval'}->{'SunUp'};
my $sleep_time_night = $config->{'General'}->{'ImageInterval'}->{'SunDown'};
my $fetch_sleep;
my $last_gstore_push = 0;
my $gstore_interval = $config->{'GStore'}->{'PushInterval'}->{'SunUp'};
my $prev_failed_start = 0;
my $s = new SC6::Cam::Sun();
my $end_time;
while() {
    $fetch_sleep = $sleep_time;
    my $dt = DateTime->now(  time_zone => $config->{'General'}->{'Timezone'} );
    if ( $s->is_sun($dt) || $force ) {  # inefficient to do this everytime, but who cares
        print "Sun is up! $dt\n";
    }
    else {
        print "Sun is down! $dt\n";

        # do some things during the first hour the sun is down
        # we should really do this all once but instead we do it a bunch, but only for an hour :)
        if ( $s->is_hour_after_dusk($dt) ) {
            $bcr->clear();  # clear bluecode
            $fetch_sleep = $sleep_time_night;
            $prev_failed_start = 0;   # make sure this doesn't carry over from the previous day
            $last_gstore_push = 0;
 
            # cp blueist to current
            my $current_dir = $config->{GStore}->{'CurrentDir'};
            my $blueist_dir = $config->{GStore}->{'BlueistDir'};
            my $blueist_image_orig = $blueist_dir . "/" . $config->{Image}->{File}->{orig};
            my $blueist_image_50pct = $blueist_dir . "/" . $config->{Image}->{File}->{'50pct'};
            $gstore->cp_bucket2bucket($blueist_image_orig, $current_dir);
            $gstore->cp_bucket2bucket($blueist_image_50pct, $current_dir);
        }
        next;
    }

    # fetch an image
    my $current_image = new SC6::Cam::Image($dt, $mode, $dryrun, $s);
    my $result = $current_image->fetch();

    if ( ! $result ) {
        print "Image fetch failed!!!!!\n";
        $fetch_sleep = 0;  # skip sleeping
        $prev_failed_start = $dt->epoch();
    }
    else {
        $current_image->getBluecode();
        $current_image->do_image_overlays();
        $current_image->resizes_and_links();
        $bcr->checkBluecode($current_image);
        
        # normal sleep, but prune sleep time to account for processing
        $end_time = DateTime->now(  time_zone => $config->{'General'}->{'Timezone'} );
        if ( $prev_failed_start != 0 ) {
            $fetch_sleep = $sleep_time - ($end_time->epoch() - $prev_failed_start);
        } 
        else {
            $fetch_sleep = $sleep_time - ($end_time->epoch() - $dt->epoch());
        }
        $prev_failed_start = 0;
        
        # push the images to gstore
        # this should really be a seperate loop or even process, but for now it's here
        if ( $last_gstore_push + $gstore_interval < $end_time->epoch() ) { 
            # this directory crap is a mess, fix it.  
            my $current = $config->{GStore}->{'CurrentDir'};
            my $www_dir = get_www_dir($format, $mode);
            my $www_image_orig = $www_dir . $config->{Image}->{File}->{orig};
            my $www_image_50pct = $www_dir . $config->{Image}->{File}->{'50pct'};
            $gstore->cp_fs2bucket($www_image_orig, $current);
            $gstore->cp_fs2bucket($www_image_50pct, $current);
            $last_gstore_push = $end_time->epoch();
        }
        else {
            print "No gstore push until ", $last_gstore_push + $gstore_interval, "\n";
        }

    }

}
continue {
    if ( $fetch_sleep >= 0 ) {
#        print "fetch_sleep: $fetch_sleep  prev_failed_start: $prev_failed_start sleep_time: $sleep_time end_time: ", $end_time->epoch(), "\n" if ( $debug );
        print "Gonna sleep: $fetch_sleep\n\n" if ( $debug );
        sleep $fetch_sleep;
    }
    else {
#        print "WTF! fetch_sleep: $fetch_sleep  prev_failed_start: $prev_failed_start sleep_time: $sleep_time end_time: ", $end_time->epoch(), "\n";
        exit 1;
    }
}

sub usage
{
    print "usage: $0 [-d|--debug] [-f|--force] [-h|--help] [-n|--dry-run] [-m|mode=mode]\n";
    print "\t-f|--force   - Force collecting of the  files\n";
    print "\t-h|--help    - This message\n";
    print "\t-n|--dry-run - perform a trial run with no changes made\n";
    print "\t-m|--mode    - mode, prod or test\n";
    exit(1);

}

sub startup_mail {
    my $mail_message = $0 . " started";
    my $mail_recip = $config->{'General'}->{'MailRecipient'};
    send_mail($mail_message, $mail_recip);
}

sub send_mail {
    my($mess, $recip) = @_;

    my $mail_cmd = $config->{'General'}->{'MailCommand'};
    my $cmd = "$mail_cmd -s \"$mess\" $recip";
    print $cmd, "\n";
    open MAIL, "| $cmd" or die "Can't open $mail_cmd: $!\n";
    print MAIL $mess;
    close MAIL;
}
